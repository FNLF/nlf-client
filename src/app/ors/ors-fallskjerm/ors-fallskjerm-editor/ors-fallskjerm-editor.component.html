<div *ngIf="!!dataReady && !error">

  <!-- STICKY TOP BAR -->
  <header class="nlf-sticky-toolbar">

    <div class="container lead">
      <!-- TITLE -->

      <!-- <fa name="file-text-o" [fixed]="true"></fa>&nbsp;-->
      <!-- {{ data.tags | nlfOrsTags: ' / '}} -->
      <span class="overflow-hidden">
        <a [routerLink]="['/ors', 'fallskjerm']">ORS</a>#{{ observation.id }}
        <nlf-resolve-observation-tags [tags]="observation.tags" [activity]="observation._model.type" link="true" seperator="/"></nlf-resolve-observation-tags>&nbsp;
        <span *ngIf="!!observation.rating" class="badge badge-{{observation.rating | nlfOrsRatingCalc | nlfDynamicColor}}">{{
          observation.rating | nlfOrsRatingCalc }}</span>
      </span>
      <!-- WORKFLOW STATE -->
      <span class="pull-right">


        <!-- SAVE -->
        <span *ngIf="!!observation">
          <span (click)="saveIfChanges()" *ngIf="!!changes && observation.acl_user.w" class="pointer badge badge-warning mx-1">
            <fa name="save" [fixed]="true"></fa>
          </span>
        </span>

        <!-- HELP -->
        <span class="badge badge-light pointer text-info mx-1" (click)="openHelp()">
          <fa name="question" [fixed]="true"></fa>
        </span>

        <!-- ABOUT -->
        <span (click)="openAbout()" class="badge badge-secondary pointer mx-1">
          <fa name="info-circle" [fixed]="true"></fa>
          <fa *ngIf="!observation.acl_user.w" name="lock" [fixed]="true" class="text-danger" title="Ingen skrivetilgang"></fa>
          {{ observation._updated | amTimeAgo }}
        </span>

        <!-- VERSION -->
        <span class="badge badge-success mx-1">v{{ observation._version }}</span>

        <!-- WORKFLOW -->
        <span class="pointer mx-1" *ngIf="observation.acl_user.x" (click)="openWorkflow()">
          <nlf-resolve-observation-state [activity]="observation._model.type" [state]="observation.workflow.state" icon="true"></nlf-resolve-observation-state>
        </span>
        <span class="mx-1" *ngIf="!observation.acl_user.x">
          <nlf-resolve-observation-state [activity]="observation._model.type" [state]="observation.workflow.state" icon="true"></nlf-resolve-observation-state>
        </span>

        <!-- DEBUG MODAL -->
        <span (click)="openDebugModal(modalDebug)" class="pointer badge badge-secondary text-white mx-1">
          <fa name="bug" [fixed]="true"></fa>
        </span>


        <!-- ACTIVITIES -->
        <span class="pointer badge badge-info mx-1" [routerLink]="['/ors', observation._model.type , 'activities', observation.id]">
          <fa name="history"></fa> Aktivitet
        </span>

        <!-- USERS!!! -->
        <nlf-ors-editor-users [model]="observation._model.type" [_id]="observation._id" [observation]="observation"></nlf-ors-editor-users>

        <!-- REPORT LINK -->
        <a [routerLink]="['/ors', observation._model.type , 'report', observation.id]" *ngIf="observation.acl_user.x || observation.acl_user.w" class="badge badge-primary text-white mx-1">
          <fa name="file" [fixed]="true"></fa> Report
        </a>

      </span>
      <!-- /WORKFLOW STATE -->
    </div>
  </header>

  <!-- CONTAINER -->
  <div class="container">

    <!-- TITLE/TAGS-->
    <div class="row my-3">
      <div class="col-sm-12 col-md-12">

        <div class="nlf-ors-toolbar">
          Tittel <nlf-help class="pull-right" key="ors-editor-title"></nlf-help>
        </div>
      </div>
      <div class="col-sm-12 col-md-12 my-3 lead">

        <nlf-ors-editor-tag [disabled]="!observation.acl_user.w" limit="15" preload="true" details="true" group="observation" [activity]="observation._model.type" [(initialTags)]="observation.tags" (change)="update($event)"></nlf-ors-editor-tag>
        <!--<nlf-ors-editor-title></nlf-ors-editor-title>-->
        <div *ngIf="!!devDebug">
          <code>{{ observation.tags | json}} </code>
        </div>

      </div>
    </div>

    <!--Type, When & Flags-->
    <div class="row my-3">
      <!-- TYPE -->
      <div class="col-sm-12 col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>Type <nlf-help class="pull-right" key="ors-editor-type"></nlf-help>
            </h5>
          </div>
          <div class="card-body">
            <nlf-ors-editor-type></nlf-ors-editor-type>
            <div *ngIf="!!devDebug">{{ observation.type }}</div>
          </div>
        </div>
      </div>
      <!-- WHEN -->
      <div class="col-sm-12 col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>Tidspunkt<nlf-help class="pull-right" key="ors-editor-when"></nlf-help>
            </h5>
          </div>
          <div class="card-body">
            <nlf-ors-editor-when tz="local"></nlf-ors-editor-when>
            <div *ngIf="!!devDebug">{{ observation.when }}</div>
          </div>
        </div>
      </div>
      <!-- FLAGS-->
      <div class="col-sm-12 col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>Flagg <nlf-help class="pull-right" key="ors-editor-flags"></nlf-help>
            </h5>
          </div>
          <div class="card-body">
            <nlf-ors-editor-flags></nlf-ors-editor-flags>
            <div *ngIf="!!devDebug">{{ observation.flags | json }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CATEGORY & OPERATIONAL -->
    <div class="row my-3">

      <div class="col-xs-12 col-md-6">
        <div class="nlf-ors-toolbar">
          Kategori <nlf-help class="pull-right" key="ors-editor-category"></nlf-help>
        </div>
        <nlf-ors-editor-categories></nlf-ors-editor-categories>
        <div *ngIf="!!devDebug">Categories for observation {{ observation.category | json }}</div>
      </div>

      <div class="col-xs-12 col-md-6">
        <div class="nlf-ors-toolbar">
          Operasjonelt <nlf-help class="pull-right" key="ors-editor-operational"></nlf-help>
        </div>
        <nlf-ors-editor-operational></nlf-ors-editor-operational>
        <div *ngIf="!!devDebug">Operationals for observation {{ observation.operational | json }}</div>
      </div>
    </div>

    <!-- RATING -->
    <div class="row my-3">
      <div class="col-xs-12 col-md-12">
        <div class="nlf-ors-toolbar">
          Alvorlighetsgrad <nlf-help class="pull-right" key="ors-editor-rating"></nlf-help>
        </div>
      </div>
      <div class="col-xs-12 col-md-12 py-3 bg-light">
        <nlf-ors-editor-rating></nlf-ors-editor-rating>
        <div *ngIf="!!devDebug">Rating for observation {{ observation.rating | json }}</div>
      </div>
    </div>

    <!-- LOCATION  -->
    <div class="nlf-ors-toolbar">
      Lokalisasjon <nlf-help class="pull-right" key="ors-editor-location"></nlf-help>
    </div>
    <nlf-ors-fallskjerm-editor-location></nlf-ors-fallskjerm-editor-location>
    <div *ngIf="!!devDebug">{{ observation.location | json }}</div>

    <!-- FILES -->
    <div class="row my-3">
      <div class="col-sm-12 col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Vedlegg ({{ observation.files.length }})
              <nlf-help class="pull-right" key="ors-editor-files"></nlf-help>
            </h5>
          </div>
          <div class="card-body table-responsive">
            <nlf-ors-editor-files [dropzone]="true" (fileChange)="save($event)"></nlf-ors-editor-files>
            <div *ngIf="!!devDebug">{{ observation.files | json }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ORGANIZATION -->
    <div class="nlf-ors-toolbar">
      Organisasjon <nlf-help class="pull-right" key="ors-editor-organization"></nlf-help>
    </div>

    <nlf-ors-fallskjerm-editor-organization></nlf-ors-fallskjerm-editor-organization>

    <!-- INVOLVERTE -->
    <div class="row my-3">
      <div class="col-xs-12 col-md-12">
        <div class="nlf-ors-toolbar">
          Involverte <nlf-help class="pull-right" key="ors-editor-involved"></nlf-help>
        </div>
      </div>
      <div class="col-xs-12 col-md-12">
        <!--
        <nlf-ors-editor-tag-persons [disabled]="!observation.acl_user.w" [persons]="observation.involved" [activity]="observation._model.type"></nlf-ors-editor-tag-persons>
        <nlf-ors-editor-people [disabled]="!observation.acl_user.w" [who]="observation.involved" path="involved"></nlf-ors-editor-people>-->
        <nlf-ors-fallskjerm-editor-involved></nlf-ors-fallskjerm-editor-involved>
        <div *ngIf="!!devDebug">{{ observation.involved | json }}</div>
      </div>
    </div>

    <!-- COMPONENTS -->
    <div class="row my-3">
      <div class="col-xs-12 col-md-12">
        <div class="nlf-ors-toolbar nlf-ors-block-bottom">
          Forløpet
          <nlf-help class="pull-right" key="ors-editor-components"></nlf-help>
          <button (click)="openPreview(modalPreview, 'components', 'Forløpet')" class="pull-right btn btn-link">
            <!--<fa name="eye" [fixed]="true"></fa>-->Preview
          </button>
        </div>
        <nlf-ors-editor-components></nlf-ors-editor-components>
        <div *ngIf="devDebug" class="col-md-12 bg-light">
          {{ observation.components | json }}
        </div>
      </div>
    </div>

    <!-- WEATHER -->
    <div class="row my-3">
      <div class="nlf-ors-toolbar nlf-ors-block-bottom">
        Været
        <nlf-help class="pull-right" key="ors-editor-weather"></nlf-help>
      </div>

      <div class="col-xs-12 col-md-5">
        <p class="lead">Auto</p>
        <nlf-ors-editor-met></nlf-ors-editor-met>
      </div>
      <div class="col-xs-12 col-md-7">
        <nlf-ors-editor-weather></nlf-ors-editor-weather>
      </div>
      <div class="col-xs-12 col-md-12">
        <div *ngIf="devDebug">
          {{ observation.weather.auto | json }}
        </div>
      </div>

    </div>

    <!-- ACTIONS -->
    <div class="nlf-ors-toolbar nlf-ors-block-bottom">
      Tiltak
      <nlf-help class="pull-right" key="ors-editor-actions"></nlf-help>
    </div>
    <nlf-ors-editor-actions></nlf-ors-editor-actions>
    <div *ngIf="!!devDebug">{{ observation.actions | json }}</div>

    <div class="nlf-ors-toolbar">
      Vurderinger
      <nlf-help class="pull-right" key="ors-editor-actions"></nlf-help>
    </div>
    <div class="row bg-light" style="padding-top:1em;padding-bottom:1em;">
      <div class="col-md-4">
        <p>
          <nlf-ors-editor-ask></nlf-ors-editor-ask>

        </p>
      </div>
      <div class="col-md-8">
        <p>
          <nlf-ors-editor-ask-text></nlf-ors-editor-ask-text>
        </p>
      </div>
    </div>

    <div *ngIf="!!devDebug">{{ observation.ask | json }}</div>

  </div><!-- /CONTAINMER-->

  <div class="container">
    <div *ngIf="!!devDebug">{{ observation |json }}</div>
  </div>

</div>

<!-- PAGE SPINNER -->
<div *ngIf="!dataReady">
  <nlf-ui-page-spinner size="5"></nlf-ui-page-spinner>
</div>

<!-- PAGE ERROR -->
<div *ngIf="!!dataReady && !!error">
  <nlf-ors-error [id]="id" activity="fallskjerm" [error]="error"></nlf-ors-error>
</div>

<!-- MODAL PREVIEW -->
<ng-template #modalPreview>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      {{ preview.title }}</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div *ngIf="preview.what==='components'">
      <nlf-report-components-timeline [components]="observation.components" [activity]="observation._model.type"></nlf-report-components-timeline>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-dark" (click)="modalRef.close()">Ferdig</button>
  </div>
</ng-template>
<!-- /MODAL PREVIEW -->

<!-- MODAL DEBUG -->
<ng-template #modalDebug>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      DEBUG #{{observation.id}}
    </h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.dismiss()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="py-3">
      <pre>{{observation | json}}</pre>
    </div>
  </div>
  <div class="modal-footer">
    <a download="observation_{{observation.id}}_v{{observation._version}}.json" [href]="getJsonFile()" class="btn btn-outline-dark mr-auto">
      <fa name="download" [fixed]="true"></fa>Last ned Json
    </a>
    <button class="btn btn-outline-dark" (click)="modalRef.close()">Ferdig</button>
  </div>
</ng-template>
<div *ngIf="!!devDebug">
  <pre>{{observation | json}}</pre>
</div>
